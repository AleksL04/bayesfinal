---
title: "FP"
output: html_document
---
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(rstan)
library(rstanarm)
library(bayesplot)
```

```{r}
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
rstan_options(threads_per_chain = 2)
```


```{r}
base_url <- "https://exoplanetarchive.ipac.caltech.edu/TAP/sync"
query_string <- "select+pl_name,disc_year,pl_rade,pl_orbper,st_met,st_teff,discoverymethod,st_mass,sy_pnum+from+ps+where+default_flag=1&format=csv"
full_url <- paste0(base_url, "?query=", query_string)

raw_planets <- read_csv(full_url)

clean_data <- raw_planets %>%
  mutate(
    log_radius = log(pl_rade),
    log_period = log(pl_orbper),
    log_st_mass = log(st_mass),
    st_teff_k = st_teff / 1000,
    method_group = fct_lump(discoverymethod, n = 3) 
  ) %>%
  filter(
    !is.na(disc_year),
    !is.na(log_radius),
    !is.na(log_period),
    !is.na(st_met),
    !is.na(st_teff_k),
    !is.na(discoverymethod),
    !is.na(log_st_mass)
  )

print(nrow(clean_data))
head(clean_data)
```

## Stan model, MCMC
We model:
$$y_i \sim Poisson(\lambda)$$
$$\lambda \sim Gamma(2,0.1)$$

```{r}
yearly_counts <- clean_data %>%
  count(disc_year) %>%
  rename(n_planets = n)

head(yearly_counts)

poisson_stan_code <- "
data {
  int<lower=0> N;
  int<lower=0> y[N];
}
parameters {
  real<lower=0> lambda;
}
model {
  lambda ~ gamma(2, 0.1);
  y ~ poisson(lambda);
}
"

stan_data <- list(
  N = nrow(yearly_counts),
  y = yearly_counts$n_planets
)

poisson_fit <- stan(
  model_code = poisson_stan_code,
  data = stan_data,
  iter = 2000,
  chains = 4
)
```

## Prior Diagnostics, Trace Plot
```{r}
print(poisson_fit, pars = "lambda")
color_scheme_set("brightblue")

mcmc_trace(
  as.array(poisson_fit),
  pars = "lambda"
)
```

## Density Plot
```{r}
mcmc_dens(as.array(poisson_fit), pars = "lambda")
```
 
## Autocorrelation Plot
```{r}
mcmc_acf(as.array(poisson_fit), pars = "lambda")
```

## R-Hat, Effective Sample Size
```{r}
summary(poisson_fit)$summary[, c("Rhat", "n_eff")]
```


## Closed Form Posterior
We model: 

$$\lambda | y \sim Gamma(a + \Sigma y, \beta + N)$$

```{r}
alpha_prior <- 2
beta_prior <- 0.1

sum_y <- sum(yearly_counts$n_planets)
N <- nrow(yearly_counts)
alpha_post <- alpha_prior + sum_y
beta_post <- beta_prior + N

#posterior mean
alpha_post / beta_post
```

## Comparison with MCMC mean
```{r}
posterior_samples <- extract(poisson_fit)$lambda
mean(posterior_samples)
```

Here, we modeled the yearly number of exoplanet discoveries using a Poisson likelihood with $Gamma (2,0.1)$ prior on the rate parameter $\gamma$. 
We estimated the posterior distribution using Hamiltonian Monte Carlo via Stan. Trace plots, density plots, and autocorrelation diagnostics indicate good chain mixing, given R-hat values hover around 1.00 and effective sample sizes appear high.
We also derived the closed-form Gamma posterior due to conjugacy and found strong agreement between the theoretical posterior mean and the MCMC based posterior mean, confirming correct model implementation and convergence


## Stan model, MCMC

We model:
$$y_i \sim \mathcal{N}(\mu, \sigma)$$
$$\mu \sim \mathcal{N}(5, 5)$$
$$\sigma \sim \text{Cauchy}(0, 5)$$

```{r}
y_val <- clean_data$log_period
N_val <- length(y_val)

mu_prior_mean <- 5.0
mu_prior_sd   <- 5.0 

stan_data_continuous <- list(
  N    = N_val,
  y    = y_val,
  mu0  = mu_prior_mean,
  tau0 = mu_prior_sd
)

continuous_stan_code <- "
data {
  int<lower=0> N;
  vector[N] y;
  real mu0;
  real tau0;
}
parameters {
  real mu;
  real<lower=0> sigma;
}
model {
  // Priors
  mu ~ normal(mu0, tau0);
  sigma ~ cauchy(0, 5); // Half-cauchy for scale
  
  // Likelihood
  y ~ normal(mu, sigma);
}
"

fit_continuous <- stan(
  model_code = continuous_stan_code,
  data = stan_data_continuous,
  iter = 10000,
  chains = 4
)
```

## Prior Diagnostics, Trace Plot

```{r}
print(fit_continuous, pars = c("mu", "sigma"))
color_scheme_set("brightblue")

mcmc_trace(
  as.array(fit_continuous), 
  pars = "mu"
) + ggtitle("Trace Plot for Mu (Log Period)")
```

## Density Plot

```{r}
mcmc_dens(as.array(fit_continuous), pars = "mu") + 
  ggtitle("Density Plot for Mu (Log Period)")
```

## Autocorrelation Plot

```{r}
mcmc_acf(as.array(fit_continuous), pars = c("mu", "sigma")) + 
  ggtitle("Autocorrelation for Mu and Sigma")
```

## R-Hat, Effective Sample Size

```{r}
summary(fit_continuous)$summary[, c("Rhat", "n_eff")]
```

## Closed Form Posterior (Approximate)

Assuming $\sigma$ is fixed at the sample standard deviation, we compare against the conjugate Normal-Normal update:

$$\frac{1}{\sigma^2_{post}} = \frac{1}{\tau_0^2} + \frac{N}{\sigma^2_{data}}$$
$$\mu_{post} = \sigma^2_{post} \left( \frac{\mu_0}{\tau_0^2} + \frac{N\bar{y}}{\sigma^2_{data}} \right)$$

```{r}
sigma_data <- sd(y_val)
y_bar      <- mean(y_val)

prior_prec <- 1 / (mu_prior_sd^2)
data_prec  <- N_val / (sigma_data^2)

post_var_theo <- 1 / (prior_prec + data_prec)

# Posterior mean
post_mean_theo <- post_var_theo * ( (mu_prior_mean * prior_prec) + (y_bar * data_prec) )
post_mean_theo
```

## Comparison with MCMC mean

```{r}
mcmc_mean <- summary(fit_continuous)$summary["mu", "mean"]
mcmc_mean
```

Here, we modeled the log period of exoplanets using a Normal likelihood with a Normal prior on the mean $\mu$ and a Half-Cauchy prior on $\sigma$.
We estimated the posterior distribution using Hamiltonian Monte Carlo via Stan. Trace plots, density plots, and autocorrelation diagnostics indicate good chain mixing, given R-hat values hover around 1.00 and effective sample sizes appear high.
We also derived the closed-form Normal posterior (conditional on $\sigma$ being known) and found strong agreement between the theoretical posterior mean and the MCMC based posterior mean, confirming correct model implementation and convergence.

# Bayesian Regression Model

We fit a multiple linear regression model to predict the log orbital period (`log_period`) based on stellar mass, effective temperature, metallicity, and the number of planets in the system.

The model specification is:

$$
y_i \sim \mathcal{N}(\mu_i, \sigma)
$$

$$
\mu_i = \alpha + \beta_1 (\text{log\_st\_mass}) + \beta_2 (\text{st\_teff\_k}) + \beta_3 (\text{st\_met}) + \beta_4 (\text{sy\_pnum})
$$

**Priors:**

  * **Coefficients (**$\beta$**):** We use weakly informative Normal priors $\mathcal{N}(0, 2.5)$ (scaled). This assumes that without seeing the data, we expect the effect sizes to be relatively small but allows for larger effects if the data supports them.
  * **Intercept (**$\alpha$**):** We use a Normal prior $\mathcal{N}(0, 10)$, centering the baseline expectation near 0 but with wide variance.
  * **Auxiliary (**$\sigma$**):** We use an Exponential prior $\text{Exp}(1)$ for the error standard deviation, constraining it to be positive and penalizing extremely large residual variance.

```{r}
# Fit the model using rstanarm
fit_stanarm <- stan_glm(
  log_period ~ log_st_mass + st_teff_k + st_met + sy_pnum,
  data = clean_data,
  family = gaussian(),
  
  prior = normal(location = 0, scale = 2.5, autoscale = TRUE),
  prior_intercept = normal(location = 0, scale = 10, autoscale = TRUE),
  prior_aux = exponential(rate = 1, autoscale = TRUE), 
  
  chains = 4,
  iter = 2000,
  seed = 123
)
```

## Diagnostics

We apply the same MCMC diagnostics used in the previous sections to ensure convergence.

### Trace Plots

```{r}
# Convert stanreg object to array for bayesplot functions
posterior_arr <- as.array(fit_stanarm)

# Plotting trace for a subset of interesting parameters
mcmc_trace(posterior_arr, pars = c("(Intercept)", "log_st_mass", "sy_pnum", "sigma")) +
  ggtitle("Trace Plots for Regression Coefficients")
```

### Density Plots

```{r}
mcmc_dens(posterior_arr, pars = c("log_st_mass", "sy_pnum", "sigma")) +
  ggtitle("Posterior Density for Select Parameters")
```

### Autocorrelation

```{r}
mcmc_acf(posterior_arr, pars = c("log_st_mass", "sy_pnum", "sigma")) +
  ggtitle("Autocorrelation for Regression Parameters")
```

### R-Hat and Effective Sample Size

```{r}
summary(fit_stanarm)[, c("Rhat", "n_eff")]
```

## Results and Interpretation

```{r}
# Summary of coefficients
print(fit_stanarm, digits = 3)

# Visualizing the posterior distributions of coefficients
plot(fit_stanarm, "areas", prob = 0.95, prob_outer = 1)
```

**Interpretation:**

  * **log\_st\_mass:** If the coefficient is positive, it suggests that more massive stars tend to host planets with longer orbital periods.
  * **sy\_pnum:** A negative coefficient for the number of planets might indicate that systems with more planets tend to be packed closer to the star (shorter periods).
  * The credible intervals (95%) do not contain zero for key parameters, indicating strong evidence for these effects.

## Predictions

We predict the `log_period` for a hypothetical star with median characteristics but a high number of planets (5 planets).

```{r}
# Create hypothetical data
new_obs <- data.frame(
  log_st_mass = median(clean_data$log_st_mass),
  st_teff_k = median(clean_data$st_teff_k),
  st_met = median(clean_data$st_met),
  sy_pnum = 5
)

# Generate posterior predictive distribution
post_preds <- posterior_predict(fit_stanarm, newdata = new_obs)

# Summarize prediction
cat("Predicted Log Period (Mean):", mean(post_preds), "\n")
cat("95% Prediction Interval:", quantile(post_preds, probs = c(0.025, 0.975)), "\n")

# Histogram of predicted values
hist(post_preds, main = "Posterior Prediction for Hypothetical 5-Planet System", xlab = "Predicted Log Period")
```

## Model Evaluation

We evaluate the model using Posterior Predictive Checks (PPC) and Leave-One-Out Cross-Validation (LOO).

### Posterior Predictive Check

This checks if the data generated by the model looks like the observed data.

```{r}
pp_check(fit_stanarm) + ggtitle("Posterior Predictive Check")
```

### Cross Validation (LOO)

We use the PSIS-LOO approximation to estimate the out-of-sample predictive performance.

```{r}
loo_result <- loo(fit_stanarm)
print(loo_result)
```
