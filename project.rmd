---
title: "FP"
output: html_document
---
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(rstan)
library(rstanarm)
library(bayesplot)
```

```{r}
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
rstan_options(threads_per_chain = 2)
```


```{r}
base_url <- "https://exoplanetarchive.ipac.caltech.edu/TAP/sync"
query_string <- "select+pl_name,disc_year,pl_rade,pl_orbper,st_met,st_teff,discoverymethod,st_mass,sy_pnum+from+ps+where+default_flag=1&format=csv"
full_url <- paste0(base_url, "?query=", query_string)

raw_planets <- read_csv(full_url)

clean_data <- raw_planets %>%
  mutate(
    log_radius = log(pl_rade),
    log_period = log(pl_orbper),
    log_st_mass = log(st_mass),
    st_teff_k = st_teff / 1000,
    method_group = fct_lump(discoverymethod, n = 3) 
  ) %>%
  filter(
    !is.na(disc_year),
    !is.na(log_radius),
    !is.na(log_period),
    !is.na(st_met),
    !is.na(st_teff_k),
    !is.na(discoverymethod),
    !is.na(log_st_mass)
  )

print(nrow(clean_data))
head(clean_data)
```

## Stan model, MCMC
We model:
$$y_i \sim Poisson(\lambda)$$
$$\lambda \sim Gamma(2,0.1)$$

```{r}
yearly_counts <- clean_data %>%
  count(disc_year) %>%
  rename(n_planets = n)

head(yearly_counts)

poisson_stan_code <- "
data {
  int<lower=0> N;
  int<lower=0> y[N];
}
parameters {
  real<lower=0> lambda;
}
model {
  lambda ~ gamma(2, 0.1);
  y ~ poisson(lambda);
}
"

stan_data <- list(
  N = nrow(yearly_counts),
  y = yearly_counts$n_planets
)

poisson_fit <- stan(
  model_code = poisson_stan_code,
  data = stan_data,
  iter = 2000,
  chains = 4
)
```

## Prior Diagnostics, Trace Plot
```{r}
print(poisson_fit, pars = "lambda")
color_scheme_set("brightblue")

mcmc_trace(
  as.array(poisson_fit),
  pars = "lambda"
)
```

## Density Plot
```{r}
mcmc_dens(as.array(poisson_fit), pars = "lambda")
```
 
## Autocorrelation Plot
```{r}
mcmc_acf(as.array(poisson_fit), pars = "lambda")
```

## R-Hat, Effective Sample Size
```{r}
summary(poisson_fit)$summary[, c("Rhat", "n_eff")]
```


## Closed Form Posterior
We model: 

$$\lambda | y \sim Gamma(a + \Sigma y, \beta + N)$$

```{r}
alpha_prior <- 2
beta_prior <- 0.1

sum_y <- sum(yearly_counts$n_planets)
N <- nrow(yearly_counts)
alpha_post <- alpha_prior + sum_y
beta_post <- beta_prior + N

#posterior mean
alpha_post / beta_post
```

## Comparison with MCMC mean
```{r}
posterior_samples <- extract(poisson_fit)$lambda
mean(posterior_samples)
```

Here, we modeled the yearly number of exoplanet discoveries using a Poisson likelihood with $Gamma (2,0.1)$ prior on the rate parameter $\gamma$. 
We estimated the posterior distribution using Hamiltonian Monte Carlo via Stan. Trace plots, density plots, and autocorrelation diagnostics indicate good chain mixing, given R-hat values hover around 1.00 and effective sample sizes appear high.
We also derived the closed-form Gamma posterior due to conjugacy and found strong agreement between the theoretical posterior mean and the MCMC based posterior mean, confirming correct model implementation and convergence


## Stan model, MCMC

We model:
$$y_i \sim \mathcal{N}(\mu, \sigma)$$
$$\mu \sim \mathcal{N}(5, 5)$$
$$\sigma \sim \text{Cauchy}(0, 5)$$

```{r}
y_val <- clean_data$log_period
N_val <- length(y_val)

mu_prior_mean <- 5.0
mu_prior_sd   <- 5.0 

stan_data_continuous <- list(
  N    = N_val,
  y    = y_val,
  mu0  = mu_prior_mean,
  tau0 = mu_prior_sd
)

continuous_stan_code <- "
data {
  int<lower=0> N;
  vector[N] y;
  real mu0;
  real tau0;
}
parameters {
  real mu;
  real<lower=0> sigma;
}
model {
  // Priors
  mu ~ normal(mu0, tau0);
  sigma ~ cauchy(0, 5); // Half-cauchy for scale
  
  // Likelihood
  y ~ normal(mu, sigma);
}
"

fit_continuous <- stan(
  model_code = continuous_stan_code,
  data = stan_data_continuous,
  iter = 10000,
  chains = 4
)
```

## Prior Diagnostics, Trace Plot

```{r}
print(fit_continuous, pars = c("mu", "sigma"))
color_scheme_set("brightblue")

mcmc_trace(
  as.array(fit_continuous), 
  pars = "mu"
) + ggtitle("Trace Plot for Mu (Log Period)")
```

## Density Plot

```{r}
mcmc_dens(as.array(fit_continuous), pars = "mu") + 
  ggtitle("Density Plot for Mu (Log Period)")
```

## Autocorrelation Plot

```{r}
mcmc_acf(as.array(fit_continuous), pars = c("mu", "sigma")) + 
  ggtitle("Autocorrelation for Mu and Sigma")
```

## R-Hat, Effective Sample Size

```{r}
summary(fit_continuous)$summary[, c("Rhat", "n_eff")]
```

## Closed Form Posterior (Approximate)

Assuming $\sigma$ is fixed at the sample standard deviation, we compare against the conjugate Normal-Normal update:

$$\frac{1}{\sigma^2_{post}} = \frac{1}{\tau_0^2} + \frac{N}{\sigma^2_{data}}$$
$$\mu_{post} = \sigma^2_{post} \left( \frac{\mu_0}{\tau_0^2} + \frac{N\bar{y}}{\sigma^2_{data}} \right)$$

```{r}
sigma_data <- sd(y_val)
y_bar      <- mean(y_val)

prior_prec <- 1 / (mu_prior_sd^2)
data_prec  <- N_val / (sigma_data^2)

post_var_theo <- 1 / (prior_prec + data_prec)

# Posterior mean
post_mean_theo <- post_var_theo * ( (mu_prior_mean * prior_prec) + (y_bar * data_prec) )
post_mean_theo
```

## Comparison with MCMC mean

```{r}
mcmc_mean <- summary(fit_continuous)$summary["mu", "mean"]
mcmc_mean
```

Here, we modeled the log period of exoplanets using a Normal likelihood with a Normal prior on the mean $\mu$ and a Half-Cauchy prior on $\sigma$.
We estimated the posterior distribution using Hamiltonian Monte Carlo via Stan. Trace plots, density plots, and autocorrelation diagnostics indicate good chain mixing, given R-hat values hover around 1.00 and effective sample sizes appear high.
We also derived the closed-form Normal posterior (conditional on $\sigma$ being known) and found strong agreement between the theoretical posterior mean and the MCMC based posterior mean, confirming correct model implementation and convergence.



```{r}
fit_stanarm <- stan_glm(
  log_period ~ log_st_mass + st_teff_k + st_met + sy_pnum,
  data = clean_data,
  family = gaussian(),
  
  prior = normal(location = 0, scale = 2.5, autoscale = TRUE),
  prior_intercept = normal(location = 0, scale = 10, autoscale = TRUE),
  prior_aux = exponential(rate = 1, autoscale = TRUE), 
  
  chains = 4,
  iter = 2000,
  seed = 123
)
```


```{r}

summary(fit_stanarm)

plot(fit_stanarm, "trace", pars = "(Intercept)")
plot(fit_stanarm, "trace", pars = "sy_pnum")

plot(fit_stanarm, "acf", pars = "sy_pnum")

plot(fit_stanarm, "areas", prob = 0.95, prob_outer = 1)
```
